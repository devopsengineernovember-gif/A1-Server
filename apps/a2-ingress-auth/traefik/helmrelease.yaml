apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik
  namespace: ingress
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/component: ingress-controller
    app.kubernetes.io/part-of: a2-stack
spec:
  interval: 5m
  chart:
    spec:
      chart: traefik
      version: "28.3.0"
      sourceRef:
        kind: HelmRepository
        name: traefik
        namespace: ingress
  values:
    deployment:
      replicas: 3
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8082"
        prometheus.io/path: "/metrics"
    
    ingressClass:
      enabled: true
      isDefaultClass: true
      name: traefik
    
    ingressRoute:
      dashboard:
        enabled: false  # We'll create a custom one with auth
    
    globalArguments:
      - "--global.checknewversion=false"
      - "--global.sendanonymoususage=false"
    
    additionalArguments:
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.format=json"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--entrypoints.web.address=:8000"
      - "--entrypoints.websecure.address=:8443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@a1-server.local"
      - "--certificatesresolvers.letsencrypt.acme.storage=/data/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    
    ports:
      web:
        port: 8000
        expose: true
        exposedPort: 80
        protocol: TCP
      websecure:
        port: 8443
        expose: true
        exposedPort: 443
        protocol: TCP
        tls:
          enabled: true
      traefik:
        port: 9000
        expose: false
        protocol: TCP
      metrics:
        port: 8082
        expose: false
        protocol: TCP
    
    service:
      enabled: true
      type: LoadBalancer
      annotations:
        metallb.universe.tf/loadBalancerIPs: "173.36.95.100"
      spec:
        externalTrafficPolicy: Local
    
    logs:
      general:
        level: INFO
      access:
        enabled: true
        filePath: "/var/log/traefik/access.log"
        format: json
    
    metrics:
      prometheus:
        addEntryPointsLabels: true
        addServicesLabels: true
        addRoutersLabels: true
    
    nodeSelector:
      node-role: "ingress"
      host: "A1"  # Temporarily using A1 until A2 is ready
    
    tolerations:
      - key: "dedicated"
        operator: "Equal"
        value: "control"
        effect: "NoSchedule"
    
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    
    persistence:
      enabled: true
      size: 1Gi
      storageClass: "longhorn"
      accessMode: ReadWriteOnce
      path: /data
    
    securityContext:
      capabilities:
        drop: [ALL]
        add: [NET_BIND_SERVICE]
      readOnlyRootFilesystem: true
      runAsGroup: 65532
      runAsNonRoot: true
      runAsUser: 65532
    
    podSecurityContext:
      fsGroup: 65532