apiVersion: v1
kind: Service
metadata:
  name: mcp-policy-proxy
  namespace: a1-orchestrator
  labels:
    app.kubernetes.io/name: mcp-policy-proxy
    app.kubernetes.io/part-of: a1-orchestrator
    app.kubernetes.io/component: policy-proxy
    app.kubernetes.io/version: "1.0.0"
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    prometheus.io/scrape: "true"
    prometheus.io/port: "8080"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: http
      protocol: TCP
      name: http
    - port: 9090
      targetPort: grpc
      protocol: TCP
      name: grpc
    - port: 8080
      targetPort: metrics
      protocol: TCP
      name: metrics
  selector:
    app.kubernetes.io/name: mcp-policy-proxy
    app.kubernetes.io/part-of: a1-orchestrator

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mcp-policy-proxy-config
  namespace: a1-orchestrator
  labels:
    app.kubernetes.io/name: mcp-policy-proxy
    app.kubernetes.io/part-of: a1-orchestrator
    app.kubernetes.io/component: policy-proxy
  annotations:
    argocd.argoproj.io/sync-wave: "1"
data:
  config.yaml: |
    server:
      http_port: 8080
      grpc_port: 9090
      metrics_port: 8080
      tls:
        enabled: true
        cert_file: /etc/certs/tls.crt
        key_file: /etc/certs/tls.key
        ca_file: /etc/ca/ca.crt
        client_auth: true
    
    policy:
      engine: "gatekeeper"
      gatekeeper:
        endpoint: "http://gatekeeper-audit.gatekeeper-system.svc.cluster.local:8080"
        timeout: "30s"
        retry_attempts: 3
        retry_delay: "1s"
      opa:
        endpoint: "http://opa.opa-system.svc.cluster.local:8181"
        timeout: "10s"
        retry_attempts: 3
        retry_delay: "500ms"
    
    orchestrator:
      api_endpoint: "${ORCHESTRATOR_API_ENDPOINT}"
      trace_endpoint: "${TRACE_ENDPOINT}"
      timeout: "30s"
      retry_attempts: 3
      retry_delay: "1s"
    
    logging:
      level: "${LOG_LEVEL}"
      format: "json"
      output: "stdout"
    
    metrics:
      enabled: true
      path: "/metrics"
      port: 8080
    
    health:
      enabled: true
      path: "/health"
      ready_path: "/ready"
    
    cache:
      enabled: true
      ttl: "5m"
      max_size: 1000
      cleanup_interval: "10m"
    
    rate_limiting:
      enabled: true
      requests_per_second: 100
      burst: 200
      per_client: true
    
    policies:
      - name: "mcp-security-policy"
        description: "Security policies for MCP agents"
        rules:
          - "no-privileged-containers"
          - "required-security-context"
          - "disallow-host-network"
          - "required-resource-limits"
      
      - name: "mcp-compliance-policy"
        description: "Compliance policies for AI orchestration"
        rules:
          - "required-labels"
          - "image-policy"
          - "network-policy-required"
          - "audit-logging-required"